<!DOCTYPE html>
<meta charset="utf-8">

<!-- Create a div where the graph will live -->
<div id="chart"></div>

<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <link rel="stylesheet" href="./custom.css">

    <title>CNN Model Visualization</title>
  </head>
  <body>
    <h1>Understanding Image Classifiers Through Visualization</h1>

    <div class="menu-container">
      <div class="button-container">
        <button py-click="reset_conv_image()" id="reset00" class="reset-button">Original Image</button>
        <button py-click="convolution('filter01')" id="filter01" class="filter-button"></button>
        <button py-click="convolution('filter02')" id="filter02" class="filter-button"></button>
        <button py-click="convolution('filter08')" id="filter08" class="filter-button"></button>
        <button py-click="convolution('filter11')" id="filter11" class="filter-button"></button>
        <button py-click="convolution('filter17')" id="filter17" class="filter-button"></button>
        <button py-click="convolution('filter21')" id="filter21" class="filter-button"></button>
        <button py-click="convolution('filter23')" id="filter23" class="filter-button"></button>
        <button py-click="convolution('filter26')" id="filter26" class="filter-button"></button>
        <button py-click="convolution('filter28')" id="filter28" class="filter-button"></button>
        <button py-click="convolution('filter31')" id="filter31" class="filter-button"></button>
        <button py-click="convolution('filter33')" id="filter33" class="filter-button"></button>
        <button py-click="convolution('filter34')" id="filter34" class="filter-button"></button>
        <button py-click="convolution('filter49')" id="filter49" class="filter-button"></button>
        <button py-click="convolution('filter57')" id="filter57" class="filter-button"></button>
        <button py-click="convolution('filter58')" id="filter58" class="filter-button"></button>

      </div>

      <div class="image-container" id="conv-results"></div>
    </div>

    <py-config>
      [splashscreen]
      autoclose = true
      packages = ["matplotlib", "pandas", "numpy", "pillow", "scipy"]
      [[fetch]]
      files = ["/assets/filt_np.npy", "/assets/filt_img.npy"]
    </py-config>
    <py-script>
      from PIL import Image
      import numpy as np
      from js import document
      filters = np.load("./assets/filt_np.npy")
      filter_imgs = np.load("./assets/filt_img.npy")
      convolution_example = Image.open("./assets/example_1.JPEG")

      def convolution(id):
        curr_elem = Element(id)
        conv_filter = np.transpose(filters[int(id[-2:])], axes=[1, 2, 0])
        conv_img = np.dstack([scipy.signal.convolve2d(np.array(fishy)[:,:,c], filt_np[27][c], mode='valid') for c in range(3)])
        conv_img = np.mean(conv_img, axis=2)

        fig, ax = plt.subplots()
        ax.xaxis.set_tick_params(labelbottom=False)
        ax.yaxis.set_tick_params(labelleft=False)
        ax.set_xticks([])
        ax.set_yticks([])

        ax.imshow((conv_img - np.min(conv_img)) / (conv_img.max()-conv_img.min()), cmap='magma')

        display(fig, target="conv-results")

      for filter_idx in [1, 2, 8, 11, 17, 21, 23, 26, 28, 31, 33, 34, 49, 57, 58]:
        button = Element("filter{id:02d}".format(id=filter_idx))
        button.write(Image.fromarray(np.transpose(filter_imgs[filter_idx], axes=[2,1,0])).resize((90,90)))
    </py-script>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>