<!DOCTYPE html>
<meta charset="utf-8">

<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <link rel="stylesheet" href="./custom.css">

    <title>CNN Model Visualization</title>
  </head>
  <body>
    <h2>Understanding Image Classifiers Through Visualization</h2>

    <div>
    <p>Since the early 2010s, convolutional neural networks (CNNs) have set the standard for the task of classifying images into predefined categories.
      The basic operation that gives CNNs their power is the convolution, where an image is transformed using a specialized filter in order to reveal patterns
      such as color, vertical or horizontal edges, different textures, or any combination of these properties.
    </p>

    <p>
      The following are visual representations of some of the convolutional filters found in the first layer of the ResNet50 network architecture.
      Click on any filter to see the transformed version of the example image. The result will be displayed as a heatmap, where "warmer" regions indicate
      a stronger response to the given filter in that area of the image.
    </p>
    </div>

    <div class="convolution-demo">
      <div class="image-container" id="conv-options">
        <div class="button-container">
          <button py-click="reset_conv_image()" id="reset00" class="reset-button">Original Image</button>
          <button py-click="convolution('filter01')" id="filter01" class="filter-button"></button>
          <button py-click="convolution('filter02')" id="filter02" class="filter-button"></button>
          <button py-click="convolution('filter08')" id="filter08" class="filter-button"></button>
          <button py-click="convolution('filter11')" id="filter11" class="filter-button"></button>
          <button py-click="convolution('filter17')" id="filter17" class="filter-button"></button>
          <button py-click="convolution('filter21')" id="filter21" class="filter-button"></button>
          <button py-click="convolution('filter23')" id="filter23" class="filter-button"></button>
          <button py-click="convolution('filter26')" id="filter26" class="filter-button"></button>
          <button py-click="convolution('filter28')" id="filter28" class="filter-button"></button>
          <button py-click="convolution('filter31')" id="filter31" class="filter-button"></button>
          <button py-click="convolution('filter33')" id="filter33" class="filter-button"></button>
          <button py-click="convolution('filter34')" id="filter34" class="filter-button"></button>
          <button py-click="convolution('filter49')" id="filter49" class="filter-button"></button>
          <button py-click="convolution('filter57')" id="filter57" class="filter-button"></button>
          <button py-click="convolution('filter58')" id="filter58" class="filter-button"></button>

        </div>
      </div>

      <div class="image-container" id="conv-results"></div>
    </div>

    <py-config>
      packages = ["matplotlib", "pandas", "numpy", "pillow", "scipy"]
      [[fetch]]
      files = ["/assets/filt_np.npy", "/assets/filt_img.npy", "/assets/example_1.JPEG"]
      [splashscreen]
      autoclose = true
    </py-config>
    <py-config>
      terminal = false
    </py-config>
    <py-script>
      from PIL import Image
      import numpy as np
      from matplotlib import pyplot as plt
      import scipy
      from js import document

      width = document.getElementById('conv-options').offsetWidth;
      filter_size = int(width * 0.22)

      filters = np.load("./assets/filt_np.npy")
      filter_imgs = np.load("./assets/filt_img.npy")
      convolution_example = Image.open("./assets/example_1.JPEG")
      fig, ax = plt.subplots()
      ax.xaxis.set_tick_params(labelbottom=False)
      ax.yaxis.set_tick_params(labelleft=False)
      ax.set_xticks([])
      ax.set_yticks([])

      def reset_conv_image():
        ax.imshow(convolution_example)
        display(fig, target="conv-results", append=False)

      def convolution(id):
        id_num = int(id[-2:])
        conv_filter = np.transpose(filters[id_num], axes=[1, 2, 0])
        conv_img = np.dstack([scipy.signal.convolve2d(np.array(convolution_example)[:,:,c], filters[id_num][c], mode='valid') for c in range(3)])
        conv_img = np.mean(conv_img, axis=2)

        ax.imshow((conv_img - np.min(conv_img)) / (conv_img.max()-conv_img.min()), cmap='magma')

        display(fig, target="conv-results", append=False)

      for filter_idx in [1, 2, 8, 11, 17, 21, 23, 26, 28, 31, 33, 34, 49, 57, 58]:
        button = Element("filter{id:02d}".format(id=filter_idx))
        button.write(Image.fromarray(np.transpose(filter_imgs[filter_idx], axes=[2,1,0]).astype('uint8')).resize((filter_size,filter_size)))

      reset_conv_image()
    </py-script>

    <div>
    <p>
      While the initial convolutions made by a model on a RGB image are the most logical choice to visualize, there are many further layers of convolutions
      (transforming the already transformed images) that lead to the complexity that gives CNNs their predictive power. We can represent this complexity quantitatively
      in terms of the total number of parameters that the model contains. Here, a "parameter" is any single numeric value that the model learns during the training process.
      Each convolution operation contains hundreds of parameters on its own.
    </p>
    </div>

    <script src="https://d3js.org/d3.v6.js"></script>
    <div id="bar-chart"></div>

    <script>
        // Set the dimensions and margins of the graph
        const margin = {top:20, right:30, left:60, bottom:30},
        width = 500 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

        const svg = d3.select("#bar-chart")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left}, ${margin.top})`);

        //Read in the data
        d3.csv("model_stats.csv", function(d){
            return {
                name: d['model_name'],
                nparams: +d['nparams'],
                top_1: +d['top1_acc'],
                top_5: d['top5_acc']
            }
        }).then(function(data){
            // Add X Scale
            const x = d3.scaleBand()
                        .domain(data.map(d => d.name))
                        .range([0, width])
                        .padding(0.2);

            // Add Y Scale
            const y = d3.scaleLinear()
                        .domain([0, d3.max(data, d => d.nparams)])
                        .range([height, 0]);

            const color = d3.scaleOrdinal()
                        .domain(data.map(d => d.name))
                        .range(d3.schemeSet3)

            var tooltip = d3.select("#bar-chart")
                             .append("div")
                             .style("position", "absolute")
                             .style("visibility", "hidden")
            // Add axes
            svg.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x));

            svg.append("g")
                .call(d3.axisLeft(y));

            let bars = svg.append("g")
                .selectAll("bar")
                .data(data)
                .join("rect")
                    .attr("x", function(d) { return x(d.name); })
                    .attr("y", function(d) { return y(d.nparams); })
                    .attr("width", function(d) {return x.bandwidth()})
                    .attr("height", function(d) {return height - y(d.nparams)})
                    .style("fill", function(d) { return color(d.name); })
                    .style("opacity", 1.0);

            bars.on('click', function(e, d) {
                bars.filter(data => data.name === d.name)
                    .style('opacity', '1.0');
                return bars.filter(data => data.name !== d.name)
                    .style('opacity', '0.5');  })
            bars.on("mouseover", function(e, d) { return tooltip
                                                            .style("visibility", "visible")
                                                            .style("font-family", "arial")
                                                            .html("Model: " + d.name
                                                            + " | Top 5 Accuracy: " + d.top_5
                                                            + " | Top 1 Accuracy: " + d.top_1); });
        })

    </script>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  </body>
</html>